<!DOCTYPE html>
<html lang="pt-BR">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Ginecologia & Obstetrícia Digital</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://unpkg.com/lucide@latest"></script>
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Inter:wght@300;400;600;700;900&display=swap');
        body { font-family: 'Inter', sans-serif; }
        .animate-in { animation: fadeIn 0.3s ease-out; }
        @keyframes fadeIn { from { opacity: 0; transform: translateY(10px); } to { opacity: 1; transform: translateY(0); } }
        .loading-shimmer { background: linear-gradient(90deg, #f0f0f0 25%, #e0e0e0 50%, #f0f0f0 75%); background-size: 200% 100%; animation: shimmer 1.5s infinite; }
        @keyframes shimmer { 0% { background-position: 200% 0; } 100% { background-position: -200% 0; } }
        .tab-active { border-bottom-width: 4px; border-color: #2563eb; background-color: #eff6ff; color: #1e40af; }
    </style>
</head>
<body class="bg-slate-100 min-h-screen p-2 md:p-6 text-slate-900">

    <div class="max-w-6xl mx-auto space-y-4">
        <!-- Header -->
        <header class="bg-indigo-900 text-white p-6 rounded-t-2xl shadow-lg flex flex-col md:flex-row justify-between items-center gap-4">
            <div class="flex items-center gap-3">
                <div class="bg-white/20 p-2 rounded-lg">
                    <i data-lucide="activity" class="text-white"></i>
                </div>
                <div>
                    <h1 class="text-2xl font-black flex items-center gap-2 tracking-tight">
                        MedAssist GO ✨
                    </h1>
                    <p class="text-indigo-200 text-xs italic">Inteligência Médica em Ginecologia e Obstetrícia</p>
                </div>
            </div>

            <!-- Seletor de Modelo -->
            <div class="bg-indigo-800 p-1 rounded-xl flex gap-1">
                <button onclick="switchModel('OBSTETRICO')" id="btn-model-obst" class="px-4 py-2 text-xs font-bold rounded-lg transition-all bg-white text-indigo-900 shadow-md">
                    OBSTETRÍCIA
                </button>
                <button onclick="switchModel('GINECOLOGICO')" id="btn-model-gyn" class="px-4 py-2 text-xs font-bold rounded-lg transition-all text-indigo-100 hover:bg-white/10">
                    GINECOLOGIA
                </button>
            </div>
        </header>

        <!-- Navegação de Abas -->
        <nav class="flex bg-white border-x border-slate-200 shadow-sm overflow-x-auto">
            <button onclick="switchTab('clinica')" id="tab-clinica" class="flex-1 min-w-[150px] py-4 text-sm font-bold uppercase tracking-wider flex items-center justify-center gap-2 transition-all tab-active">
                <i data-lucide="stethoscope" class="w-4 h-4"></i> Anamnese & Físico
            </button>
            <button onclick="switchTab('documentos')" id="tab-documentos" class="flex-1 min-w-[150px] py-4 text-sm font-bold uppercase tracking-wider flex items-center justify-center gap-2 transition-all text-slate-400 border-b-4 border-transparent hover:text-slate-600">
                <i data-lucide="file-text" class="w-4 h-4"></i> IA & Documentos ✨
            </button>
        </nav>

        <main class="bg-white shadow-xl rounded-b-2xl p-4 md:p-8 space-y-10 border-x border-b border-slate-200">
            
            <!-- SEÇÃO CLÍNICA -->
            <div id="content-clinica" class="space-y-10 animate-in">
                <section>
                    <div class="flex items-center gap-2 mb-4 border-b pb-2 text-indigo-900">
                        <span class="bg-indigo-600 text-white w-6 h-6 rounded-full flex items-center justify-center text-xs font-bold">1</span>
                        <h2 class="text-lg font-bold uppercase tracking-tight">Identificação e Antecedentes</h2>
                    </div>
                    
                    <div class="grid grid-cols-1 md:grid-cols-4 gap-4">
                        <div class="md:col-span-2">
                            <label class="text-[10px] font-bold text-slate-500 uppercase">Nome Completo</label>
                            <input type="text" id="nome" class="w-full p-2 border rounded-md bg-slate-50 uppercase focus:ring-2 focus:ring-indigo-400 outline-none" placeholder="NOME DA PACIENTE">
                        </div>
                        <div>
                            <label class="text-[10px] font-bold text-slate-500 uppercase">Idade</label>
                            <input type="text" id="idade" class="w-full p-2 border rounded-md bg-slate-50">
                        </div>
                        <div>
                            <label class="text-[10px] font-bold text-slate-500 uppercase">Prontuário</label>
                            <input type="text" id="prontuario" class="w-full p-2 border rounded-md bg-slate-50">
                        </div>

                        <!-- Campos Obstétricos -->
                        <div class="grid grid-cols-4 gap-2 obst-only">
                            <div><label class="text-[10px] font-bold block">G</label><input id="ge" class="w-full p-1 border rounded text-center"></div>
                            <div><label class="text-[10px] font-bold block">PN</label><input id="pa_n" class="w-full p-1 border rounded text-center"></div>
                            <div><label class="text-[10px] font-bold block">PC</label><input id="pa_c" class="w-full p-1 border rounded text-center"></div>
                            <div><label class="text-[10px] font-bold block">A</label><input id="ab" class="w-full p-1 border rounded text-center"></div>
                        </div>
                        
                        <!-- Campos Ginecológicos -->
                        <div class="grid grid-cols-2 gap-2 gyn-only hidden">
                            <div><label class="text-[10px] font-bold block uppercase">DUM</label><input id="dum" type="text" placeholder="DD/MM/AA" class="w-full p-2 border rounded text-center text-xs"></div>
                            <div><label class="text-[10px] font-bold block uppercase">MAC</label><input id="mac" type="text" placeholder="Método Contraceptivo" class="w-full p-2 border rounded text-xs uppercase"></div>
                        </div>

                        <div class="obst-only">
                            <label class="text-[10px] font-bold text-slate-500 uppercase">Último Parto há</label>
                            <input id="ultimoParto" class="w-full p-2 border rounded-md bg-slate-50 uppercase" placeholder="ex: 2 ANOS">
                        </div>
                        
                        <div class="gyn-only hidden">
                            <label class="text-[10px] font-bold text-slate-500 uppercase">Sexualmente Ativa?</label>
                            <select id="sexo_ativa" class="w-full p-2 border rounded-md bg-slate-50 text-xs">
                                <option value="SIM">SIM</option>
                                <option value="NÃO">NÃO</option>
                            </select>
                        </div>

                        <div>
                            <label class="text-[10px] font-bold text-slate-500 uppercase">Alergias</label>
                            <input id="alergias" class="w-full p-2 border rounded-md bg-slate-50 uppercase" value="NEGA">
                        </div>
                        <div>
                            <label class="text-[10px] font-bold text-slate-500 uppercase">Cirurgias Prévias</label>
                            <input id="cirurgias" class="w-full p-2 border rounded-md bg-slate-50 uppercase" placeholder="APENDICECTOMIA, ETC">
                        </div>
                    </div>
                </section>

                <section class="bg-slate-50 p-6 rounded-2xl border border-slate-100">
                    <div class="flex items-center gap-2 mb-4">
                        <i data-lucide="help-circle" class="text-indigo-600"></i>
                        <h2 class="text-lg font-bold text-indigo-900 uppercase">História Atual</h2>
                    </div>
                    <div class="space-y-4">
                        <div>
                            <label class="text-[10px] font-bold text-indigo-800 uppercase">Queixa Principal (QP)</label>
                            <input type="text" id="qp" class="w-full p-3 border border-indigo-200 rounded-lg text-lg font-bold uppercase shadow-sm focus:ring-2 focus:ring-indigo-400 outline-none" placeholder="ex: SANGRAMENTO VAGINAL">
                        </div>
                        <div>
                            <label class="text-[10px] font-bold text-indigo-800 uppercase">HDA (Desenvolvimento da Queixa)</label>
                            <textarea id="hda" class="w-full p-3 border border-indigo-200 rounded-lg h-32 text-sm uppercase focus:ring-2 focus:ring-indigo-400 outline-none" placeholder="Relate o início, fatores de melhora/piora, sintomas associados..."></textarea>
                        </div>
                    </div>
                </section>

                <section>
                    <div class="flex items-center gap-2 mb-4 border-b pb-2 text-indigo-900">
                        <span class="bg-indigo-600 text-white w-6 h-6 rounded-full flex items-center justify-center text-xs font-bold">3</span>
                        <h2 class="text-lg font-bold uppercase tracking-tight">Exame Físico</h2>
                    </div>
                    <div class="grid grid-cols-1 md:grid-cols-3 gap-6">
                        <!-- Sinais Vitais -->
                        <div class="space-y-4 bg-slate-50 p-4 rounded-xl border border-slate-200 shadow-sm">
                            <p class="text-[10px] font-bold text-slate-400 uppercase">Sinais Vitais</p>
                            <div class="grid grid-cols-2 gap-2">
                                <div class="col-span-2 flex gap-2">
                                    <input id="pa_sist" class="flex-1 p-2 border rounded text-center text-sm" placeholder="SIS">
                                    <span class="flex items-center">x</span>
                                    <input id="pa_diast" class="flex-1 p-2 border rounded text-center text-sm" placeholder="DIA">
                                </div>
                                <input id="fc_val" class="p-2 border rounded text-center text-sm" placeholder="FC (bpm)">
                                <input id="tax_val" class="p-2 border rounded text-center text-sm" placeholder="TAX" value="AFEBRIL">
                            </div>
                            <input id="exameGeral" class="w-full p-2 border rounded text-xs uppercase" value="BEG, AAA, CORADA E HIDRATADA">
                        </div>
                        
                        <!-- Obstétrico / Abdome -->
                        <div class="space-y-4 bg-slate-50 p-4 rounded-xl border border-slate-200 shadow-sm">
                            <p class="text-[10px] font-bold text-slate-400 uppercase" id="label-fetal">Fetal / Abdome</p>
                            <div class="flex gap-2 obst-only">
                                <div class="flex-1 text-center"><label class="text-[9px] font-bold block uppercase text-slate-500">AFU (cm)</label><input id="afu" class="w-full p-2 border rounded text-center font-bold"></div>
                                <div class="flex-1 text-center"><label class="text-[9px] font-bold block text-indigo-600 uppercase">BCF (bpm)</label><input id="bcf" class="w-full p-2 border border-indigo-400 rounded text-center font-bold text-indigo-600"></div>
                            </div>
                            <div class="gyn-only hidden space-y-2">
                                <label class="text-[9px] font-bold block uppercase text-slate-500">Palpação Abdominal</label>
                                <input id="abd_palp" class="w-full p-2 border rounded text-xs uppercase" value="ABDOME PLANO, RHA+, INDOLOR">
                            </div>
                            <input id="dinamica" class="w-full p-2 border rounded text-xs uppercase obst-only" placeholder="DINÂMICA" value="AUSENTE">
                            <input id="mov_fetal" class="w-full p-2 border rounded text-xs uppercase obst-only" placeholder="MOV. FETAIS" value="PRESENTES">
                        </div>

                        <!-- Especular e Toque -->
                        <div class="space-y-4">
                            <p class="text-[10px] font-bold text-slate-400 uppercase">Exame Pelviano</p>
                            <textarea id="especular" class="w-full p-2 border rounded text-[10px] h-14 uppercase" placeholder="ESPECULAR">COLO TRÓFICO, ORIFÍCIO EXTERNO PUNTIFORME. CONTEÚDO FISIOLÓGICO.</textarea>
                            <textarea id="tv" class="w-full p-2 border rounded text-[10px] h-14 uppercase" placeholder="TOQUE VAGINAL">COLO POSTERIOR, IMPÉRVIO, GROSSO.</textarea>
                        </div>
                    </div>
                </section>
            </div>

            <!-- ABA IA & DOCUMENTOS -->
            <div id="content-documentos" class="hidden space-y-8 animate-in">
                <!-- LEITURA MULTIMODAL ✨ -->
                <section class="bg-indigo-900 p-6 rounded-2xl text-white shadow-xl relative overflow-hidden">
                    <div class="relative z-10 grid grid-cols-1 md:grid-cols-2 gap-6">
                        <div>
                            <div class="flex items-center gap-2 mb-2">
                                <i data-lucide="zap" class="text-yellow-400"></i>
                                <h3 class="font-black uppercase tracking-widest text-sm">Leitura Inteligente ✨</h3>
                            </div>
                            <p class="text-indigo-200 text-[10px] mb-4 uppercase">Arraste uma foto do prontuário ou cole o texto para preencher o formulário.</p>
                            
                            <div class="flex flex-col gap-3">
                                <div class="relative group">
                                    <input type="file" id="file-input" accept="image/*,application/pdf" class="absolute inset-0 opacity-0 cursor-pointer z-20">
                                    <div class="p-4 border-2 border-dashed border-indigo-400 rounded-xl bg-indigo-800/50 flex flex-col items-center gap-2 group-hover:bg-indigo-800 transition-all">
                                        <i data-lucide="upload-cloud" class="text-indigo-300"></i>
                                        <span class="text-xs font-bold" id="file-name">Carregar Foto ou PDF</span>
                                    </div>
                                </div>
                                <textarea id="magic-paste" class="w-full p-3 bg-indigo-800 border border-indigo-700 rounded-lg text-xs h-20 text-indigo-100 placeholder-indigo-400 outline-none focus:ring-2 focus:ring-indigo-400 transition-all" placeholder="OU COLE O TEXTO AQUI..."></textarea>
                            </div>
                        </div>

                        <div class="flex flex-col justify-end gap-3">
                            <button onclick="parseClinicalData()" id="parse-btn" class="bg-indigo-500 hover:bg-indigo-400 text-white w-full py-4 rounded-xl text-xs font-black flex items-center justify-center gap-2 shadow-lg transition-all active:scale-95">
                                <i data-lucide="bot" class="w-4 h-4"></i> PROCESSAR COM INTELIGÊNCIA ARTIFICIAL
                            </button>
                            <p class="text-[9px] text-center text-indigo-300 uppercase font-bold tracking-tighter">O sistema irá ler fotos de receitas, USG e prontuários manuais.</p>
                        </div>
                    </div>
                    <!-- Decorativa -->
                    <div class="absolute -bottom-10 -right-10 opacity-5 pointer-events-none">
                        <i data-lucide="stethoscope" style="width: 250px; height: 250px;"></i>
                    </div>
                </section>

                <!-- Exames Complementares -->
                <section class="grid grid-cols-1 md:grid-cols-2 gap-6">
                    <div class="space-y-6">
                        <div class="bg-slate-50 p-4 rounded-xl border border-slate-200">
                            <h3 class="text-xs font-black text-indigo-900 uppercase mb-3 flex items-center gap-2 italic">
                                <i data-lucide="flask-conical" class="w-3 h-3 text-indigo-500"></i> Laboratórios
                            </h3>
                            <textarea id="labs" class="w-full p-2 border rounded text-xs h-32 font-mono uppercase bg-white focus:ring-2 focus:ring-indigo-400 outline-none" placeholder="HB/HT, LEUCO, PLAQ, PCR..."></textarea>
                        </div>
                    </div>
                    <div class="space-y-6">
                        <div class="bg-indigo-50/50 p-4 rounded-xl border border-indigo-100">
                            <h3 class="text-xs font-black text-indigo-900 uppercase mb-3 flex items-center gap-2 italic">
                                <i data-lucide="image" class="w-3 h-3 text-indigo-500"></i> Ultrassonografia
                            </h3>
                            <textarea id="usg" class="w-full p-2 border border-indigo-200 rounded text-xs h-32 uppercase bg-white focus:ring-2 focus:ring-indigo-400 outline-none" placeholder="DESCRIÇÃO DA IMAGEM..."></textarea>
                        </div>
                    </div>
                </section>
            </div>

            <!-- RESULTADO E CONDUTA -->
            <section class="bg-slate-900 text-white p-6 rounded-2xl shadow-2xl space-y-6">
                <div class="flex justify-between items-center border-b border-slate-700 pb-2">
                    <h2 class="text-sm font-bold uppercase tracking-widest text-indigo-400 flex items-center gap-2">
                        <i data-lucide="check-circle" class="w-4 h-4"></i> Conclusão Médica
                    </h2>
                    <button onclick="getAISuggestion()" id="ai-suggestion-btn" class="bg-indigo-700 hover:bg-indigo-600 px-4 py-2 rounded-lg text-[10px] font-black flex items-center gap-2 transition-all">
                        <i data-lucide="sparkles" class="w-3 h-3"></i> SUGESTÃO DE CONDUTA ✨
                    </button>
                </div>
                
                <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
                    <div class="space-y-4">
                        <label class="text-[10px] font-bold text-slate-400 uppercase">Hipótese Diagnóstica (HD)</label>
                        <input id="hd_final" class="w-full bg-slate-800 border-b-2 border-slate-600 p-2 text-xl font-black text-red-400 uppercase outline-none focus:border-red-400 transition-all" placeholder="DIAGNÓSTICO FINAL...">
                        
                        <div class="grid grid-cols-2 gap-4 mt-4">
                            <div>
                                <label class="text-[10px] font-bold text-slate-400 uppercase">Staff</label>
                                <input id="staff" class="w-full bg-slate-800 border border-slate-700 rounded p-2 text-xs uppercase" placeholder="DR(A)...">
                            </div>
                            <div>
                                <label class="text-[10px] font-bold text-slate-400 uppercase">Data/Hora</label>
                                <div id="display-time" class="p-2 text-xs font-mono text-slate-400">--:--</div>
                            </div>
                        </div>
                    </div>
                    <div>
                        <label class="text-[10px] font-bold text-slate-400 uppercase">Plano de Conduta Detalhado</label>
                        <textarea id="conduta_final" class="w-full bg-slate-800 border border-slate-700 rounded p-3 text-xs h-32 outline-none uppercase focus:ring-2 focus:ring-indigo-500 transition-all" placeholder="MEDICAÇÕES, ORIENTAÇÕES, EXAMES..."></textarea>
                    </div>
                </div>

                <div id="ai-box" class="hidden bg-indigo-950/50 border border-indigo-500/50 p-4 rounded-xl animate-in">
                    <div class="flex justify-between items-center mb-2">
                        <p class="text-[10px] font-black text-indigo-300 uppercase flex items-center gap-1"><i data-lucide="brain" class="w-3 h-3"></i> Análise do Gemini 2.5 Flash</p>
                        <button onclick="document.getElementById('ai-box').classList.add('hidden')" class="text-[9px] text-slate-500 uppercase">Fechar</button>
                    </div>
                    <div id="ai-content" class="text-xs text-indigo-100 leading-relaxed italic"></div>
                </div>

                <button onclick="generateFinal()" class="w-full py-5 bg-indigo-600 hover:bg-indigo-500 text-white font-black text-lg rounded-xl flex items-center justify-center gap-3 uppercase shadow-lg transition-all active:scale-[0.98]">
                    <i data-lucide="file-check" class="w-6 h-6"></i> FINALIZAR ATENDIMENTO E GERAR TEXTO
                </button>
            </section>

            <!-- RESULTADO FINAL -->
            <div id="result-box" class="hidden space-y-2 animate-in">
                <div class="bg-indigo-100 px-6 py-3 flex justify-between items-center rounded-t-xl border-x border-t border-indigo-200">
                    <span class="text-[10px] font-black text-indigo-800 uppercase tracking-widest">Evolução de Prontuário Padronizada</span>
                    <button onclick="copyToClipboard()" id="copy-btn" class="bg-indigo-700 hover:bg-indigo-600 text-white px-5 py-2 rounded-lg text-[10px] font-black shadow-md flex items-center gap-2">
                        <i data-lucide="copy" class="w-3 h-3"></i> COPIAR TUDO
                    </button>
                </div>
                <div class="bg-white border-2 border-indigo-200 p-8 rounded-b-xl shadow-inner overflow-x-auto min-h-[300px]">
                    <pre id="final-text" class="text-slate-800 font-mono text-[11px] whitespace-pre-wrap select-all leading-tight"></pre>
                </div>
            </div>

        </main>
    </div>

    <script>
        // CONFIGURAÇÕES GLOBAIS
        const API_KEY = "AIzaSyCqzFaH4nQGkBLLLTDyEQtbtwAUxTFeoH0"; 
        let currentModel = 'OBSTETRICO';

        // Inicialização de UI
        lucide.createIcons();
        setInterval(() => {
            const now = new Date();
            document.getElementById('display-time').innerText = now.toLocaleDateString('pt-BR') + ' ' + now.toLocaleTimeString('pt-BR', {hour: '2-digit', minute:'2-digit'});
        }, 1000);

        // Upload de Arquivo UI
        document.getElementById('file-input').addEventListener('change', function(e) {
            const fileName = e.target.files[0] ? e.target.files[0].name : "Carregar Foto ou PDF";
            document.getElementById('file-name').innerText = fileName;
        });

        // Alternância de Modelo (Obstétrico vs Ginecológico)
        function switchModel(model) {
            currentModel = model;
            const btnObst = document.getElementById('btn-model-obst');
            const btnGyn = document.getElementById('btn-model-gyn');
            const obstFields = document.querySelectorAll('.obst-only');
            const gynFields = document.querySelectorAll('.gyn-only');

            if (model === 'OBSTETRICO') {
                btnObst.className = "px-4 py-2 text-xs font-bold rounded-lg transition-all bg-white text-indigo-900 shadow-md";
                btnGyn.className = "px-4 py-2 text-xs font-bold rounded-lg transition-all text-indigo-100 hover:bg-white/10";
                obstFields.forEach(el => el.classList.remove('hidden'));
                gynFields.forEach(el => el.classList.add('hidden'));
                document.getElementById('label-fetal').innerText = "Fetal / Abdome";
            } else {
                btnGyn.className = "px-4 py-2 text-xs font-bold rounded-lg transition-all bg-white text-indigo-900 shadow-md";
                btnObst.className = "px-4 py-2 text-xs font-bold rounded-lg transition-all text-indigo-100 hover:bg-white/10";
                obstFields.forEach(el => el.classList.add('hidden'));
                gynFields.forEach(el => el.classList.remove('hidden'));
                document.getElementById('label-fetal').innerText = "Abdome / Palpação";
            }
        }

        // Navegação de Abas
        function switchTab(tab) {
            const btnClinica = document.getElementById('tab-clinica');
            const btnDocumentos = document.getElementById('tab-documentos');
            const contentClinica = document.getElementById('content-clinica');
            const contentDocumentos = document.getElementById('content-documentos');

            if (tab === 'clinica') {
                btnClinica.classList.add('tab-active');
                btnClinica.classList.remove('text-slate-400');
                btnDocumentos.classList.remove('tab-active');
                btnDocumentos.classList.add('text-slate-400');
                contentClinica.classList.remove('hidden');
                contentDocumentos.classList.add('hidden');
            } else {
                btnDocumentos.classList.add('tab-active');
                btnDocumentos.classList.remove('text-slate-400');
                btnClinica.classList.remove('tab-active');
                btnClinica.classList.add('text-slate-400');
                contentDocumentos.classList.remove('hidden');
                contentClinica.classList.add('hidden');
            }
        }

        // FUNÇÃO DE LEITURA INTELIGENTE (TEXTO OU IMAGEM) ✨
        async function parseClinicalData() {
            const rawText = document.getElementById('magic-paste').value;
            const fileInput = document.getElementById('file-input');
            const btn = document.getElementById('parse-btn');
            
            if (!rawText && !fileInput.files[0]) {
                alert("Por favor, cole um texto ou carregue uma imagem/PDF.");
                return;
            }

            btn.disabled = true;
            btn.innerHTML = `<i data-lucide="loader-2" class="w-4 h-4 animate-spin"></i> ANALISANDO DADOS...`;
            lucide.createIcons();

            try {
                let contents = [];
                let promptText = `Você é um assistente médico especialista em Ginecologia e Obstetrícia. 
                Sua tarefa é extrair TODOS os dados clínicos do material fornecido e retornar APENAS um objeto JSON.
                Material pode ser texto ou imagem de prontuário, receita ou exame.
                Extraia para estes campos (se existirem): 
                nome, idade, prontuario, ge, pa_n, pa_c, ab, ultimoParto, dum, mac, qp, hda, pa_sist, pa_diast, fc, tax, afu, bcf, labs, usg.
                
                Responda APENAS o JSON puro.`;

                if (fileInput.files[0]) {
                    const base64 = await fileToBase64(fileInput.files[0]);
                    contents = [{
                        parts: [
                            { text: promptText },
                            { inlineData: { mimeType: fileInput.files[0].type, data: base64 } }
                        ]
                    }];
                } else {
                    contents = [{ parts: [{ text: promptText + "\n\nTexto: " + rawText }] }];
                }

                const response = await fetch(`https://generativelanguage.googleapis.com/v1beta/models/gemini-2.5-flash-preview-09-2025:generateContent?key=${API_KEY}`, {
                    method: 'POST',
                    headers: {'Content-Type': 'application/json'},
                    body: JSON.stringify({
                        contents: contents,
                        generationConfig: { responseMimeType: "application/json" }
                    })
                });

                const data = await response.json();
                const clinicalData = JSON.parse(data.candidates[0].content.parts[0].text);

                // Preenchimento Automático
                if(clinicalData.nome) document.getElementById('nome').value = clinicalData.nome;
                if(clinicalData.idade) document.getElementById('idade').value = clinicalData.idade;
                if(clinicalData.prontuario) document.getElementById('prontuario').value = clinicalData.prontuario;
                if(clinicalData.ge) document.getElementById('ge').value = clinicalData.ge;
                if(clinicalData.pa_n) document.getElementById('pa_n').value = clinicalData.pa_n;
                if(clinicalData.pa_c) document.getElementById('pa_c').value = clinicalData.pa_c;
                if(clinicalData.ab) document.getElementById('ab').value = clinicalData.ab;
                if(clinicalData.ultimoParto) document.getElementById('ultimoParto').value = clinicalData.ultimoParto;
                if(clinicalData.dum) document.getElementById('dum').value = clinicalData.dum;
                if(clinicalData.mac) document.getElementById('mac').value = clinicalData.mac;
                if(clinicalData.qp) document.getElementById('qp').value = clinicalData.qp;
                if(clinicalData.hda) document.getElementById('hda').value = clinicalData.hda;
                if(clinicalData.pa_sist) document.getElementById('pa_sist').value = clinicalData.pa_sist;
                if(clinicalData.pa_diast) document.getElementById('pa_diast').value = clinicalData.pa_diast;
                if(clinicalData.fc) document.getElementById('fc_val').value = clinicalData.fc;
                if(clinicalData.afu) document.getElementById('afu').value = clinicalData.afu;
                if(clinicalData.bcf) document.getElementById('bcf').value = clinicalData.bcf;
                if(clinicalData.labs) document.getElementById('labs').value = clinicalData.labs;
                if(clinicalData.usg) document.getElementById('usg').value = clinicalData.usg;

                btn.classList.add('bg-green-600');
                btn.innerHTML = `<i data-lucide="check-circle" class="w-4 h-4"></i> FORMULÁRIO PREENCHIDO!`;
                
                // Mudar para modelo GYNECOLOGICO se detectar DUM ou MAC sem dados obstétricos
                if ((clinicalData.dum || clinicalData.mac) && !clinicalData.ge) {
                    switchModel('GINECOLOGICO');
                } else {
                    switchModel('OBSTETRICO');
                }

                setTimeout(() => {
                    btn.disabled = false;
                    btn.classList.remove('bg-green-600');
                    btn.innerHTML = `<i data-lucide="bot" class="w-4 h-4"></i> PROCESSAR COM INTELIGÊNCIA ARTIFICIAL`;
                    lucide.createIcons();
                }, 3000);

            } catch (error) {
                console.error(error);
                btn.innerHTML = `<i data-lucide="alert-triangle" class="w-4 h-4"></i> ERRO NO PROCESSAMENTO`;
                btn.classList.add('bg-red-600');
                setTimeout(() => {
                    btn.disabled = false;
                    btn.classList.remove('bg-red-600');
                    btn.innerHTML = `<i data-lucide="bot" class="w-4 h-4"></i> PROCESSAR COM INTELIGÊNCIA ARTIFICIAL`;
                    lucide.createIcons();
                }, 3000);
            }
        }

        // Sugestão de Conduta com Gemini ✨
        async function getAISuggestion() {
            const btn = document.getElementById('ai-suggestion-btn');
            const aiBox = document.getElementById('ai-box');
            const aiContent = document.getElementById('ai-content');
            
            btn.disabled = true;
            btn.innerHTML = `<i data-lucide="loader-2" class="w-3 h-3 animate-spin"></i> ANALISANDO...`;
            lucide.createIcons();

            const prompt = `Como médico obstetra/ginecologista, sugira Hipótese Diagnóstica e Conduta. 
            Tipo: ${currentModel}. 
            QP: ${document.getElementById('qp').value}. 
            HDA: ${document.getElementById('hda').value}. 
            Exame: PA ${document.getElementById('pa_sist').value}x${document.getElementById('pa_diast').value}, BCF ${document.getElementById('bcf').value}, AFU ${document.getElementById('afu').value}.
            Labs: ${document.getElementById('labs').value}.
            Responda de forma direta e técnica em tópicos.`;

            try {
                const resp = await fetch(`https://generativelanguage.googleapis.com/v1beta/models/gemini-2.5-flash-preview-09-2025:generateContent?key=${API_KEY}`, {
                    method: 'POST',
                    headers: {'Content-Type': 'application/json'},
                    body: JSON.stringify({
                        contents: [{parts: [{text: prompt}]}],
                        systemInstruction: {parts: [{text: "Você é um professor de medicina experiente. Responda em Português do Brasil com termos técnicos médicos."}]}
                    })
                });
                const data = await resp.json();
                const suggestion = data.candidates[0].content.parts[0].text;
                
                aiContent.innerText = suggestion;
                aiBox.classList.remove('hidden');
                btn.disabled = false;
                btn.innerHTML = `<i data-lucide="sparkles" class="w-3 h-3"></i> SUGESTÃO DE CONDUTA ✨`;
                lucide.createIcons();
            } catch (e) {
                aiContent.innerText = "Falha ao consultar a base de conhecimento. Verifique sua conexão.";
                aiBox.classList.remove('hidden');
                btn.disabled = false;
                btn.innerHTML = `<i data-lucide="sparkles" class="w-3 h-3"></i> SUGESTÃO DE CONDUTA ✨`;
                lucide.createIcons();
            }
        }

        // Conversor de Arquivo
        function fileToBase64(file) {
            return new Promise((resolve, reject) => {
                const reader = new FileReader();
                reader.readAsDataURL(file);
                reader.onload = () => resolve(reader.result.split(',')[1]);
                reader.onerror = error => reject(error);
            });
        }

        // GERAR TEXTO FINAL PADRONIZADO
        function generateFinal() {
            const getV = (id) => document.getElementById(id).value.toUpperCase().trim() || 'NEGA/NÃO INFORMADO';
            const dataAtual = new Date().toLocaleDateString('pt-BR');
            const horaAtual = new Date().toLocaleTimeString('pt-BR', {hour: '2-digit', minute:'2-digit'});
            
            let text = "";

            if (currentModel === 'OBSTETRICO') {
                text = `## URGÊNCIA OBSTETRÍCIA MATERNIDADE - DATA ${dataAtual} ###

- NOME: ${getV('nome')}
- IDADE: ${getV('idade')} ANOS
- PRONTUÁRIO: ${getV('prontuario')}
- PARIDADE: G${getV('ge')} P${getV('pa_n')}N${getV('pa_c')}C A${getV('ab')}
   >> ÚLTIMO PARTO/ CESÁREA HÁ: ${getV('ultimoParto')}
- IG: CALC. PELA IA/EXAME (SIC)
- TS: NÃO INF. | TOXOPLASMOSE: - | GJ: -
- COMORBIDADES: ${getV('comorbidades')}
- ALERGIAS: ${getV('alergias')}
- CIRURGIAS PRÉVIAS: ${getV('cirurgias')}

# QP: "${getV('qp')}"

# HDA: ${getV('hda')}

# HD: NEGA: SANGRAMENTOS, METROSSISTOLES, CORRIMENTO VAGINAL, PERDAS VAGINAIS, QUEIXAS URINARIAS.

# EXAME FÍSICO: 
- ${getV('exameGeral')}
- SINAIS VITAIS: PA: ${getV('pa_sist')}X${getV('pa_diast')} MMHG / FC: ${getV('fc_val')} BPM
- ACV: RCR, 2T , BNF, SS
- AR: MV+, SRA, SEM SINAIS DE DESCONFORTO RESPIRATÓRIO
- ABD: ABDOME GRAVIDICO, SEM DOR A PALPAÇÃO, RHA+, DB NEGATIVA.
- DINAMICA UTERINA: ${getV('dinamica')}
- AFU: ${getV('afu')} CM; AL FISIOLOGICO
- BCF: ${getV('bcf')} BPM - SEM DESACELERAÇÕES
- MOVIMENTOS FETAIS: ${getV('mov_fetal')}
- ESPECULAR: ${getV('especular')}
- TV: ${getV('tv')}
- MMII: AUSÊNCIA DE EDEMA. PANTURRILHAS LIVRES E INDOLORES

# EXAMES COMPLEMENTARES:
>> LABORATORIAIS <<
- ${getV('labs')}

>> USG <<
- ${getV('usg')}

# HD: 
- ${getV('hd_final')}

# CONDUTA DISCUTIDA E ORIENTADA POR STAFF DR(A) ${getV('staff')}
- ${getV('conduta_final')}
Atendimento finalizado em: ${dataAtual} às ${horaAtual}`;
            } else {
                text = `## ATENDIMENTO GINECOLÓGICO - DATA ${dataAtual} ###

- NOME: ${getV('nome')}
- IDADE: ${getV('idade')} ANOS
- PRONTUÁRIO: ${getV('prontuario')}
- DUM: ${getV('dum')} | MAC: ${getV('mac')}
- SEX. ATIVA: ${getV('sexo_ativa')}
- COMORBIDADES: ${getV('comorbidades')}
- ALERGIAS: ${getV('alergias')}
- CIRURGIAS PRÉVIAS: ${getV('cirurgias')}

# QP: "${getV('qp')}"

# HDA: ${getV('hda')}

# EXAME FÍSICO: 
- ${getV('exameGeral')}
- SINAIS VITAIS: PA: ${getV('pa_sist')}X${getV('pa_diast')} MMHG / FC: ${getV('fc_val')} BPM
- ACV: RCR, 2T , BNF, SS
- AR: MV+, SRA, SEM SINAIS DE DESCONFORTO RESPIRATÓRIO
- ABD: ${getV('abd_palp')}
- ESPECULAR: ${getV('especular')}
- TV (BIMANUAL): ${getV('tv')}
- MMII: AUSÊNCIA DE EDEMA. PANTURRILHAS LIVRES E INDOLORES

# EXAMES COMPLEMENTARES:
>> LABORATORIAIS <<
- ${getV('labs')}

>> IMAGEM (USG TV/ABD) <<
- ${getV('usg')}

# HD: 
- ${getV('hd_final')}

# CONDUTA DISCUTIDA E ORIENTADA POR STAFF DR(A) ${getV('staff')}
- ${getV('conduta_final')}
Atendimento finalizado em: ${dataAtual} às ${horaAtual}`;
            }

            document.getElementById('final-text').innerText = text;
            document.getElementById('result-box').classList.remove('hidden');
            document.getElementById('result-box').scrollIntoView({ behavior: 'smooth' });
        }

        // Função de Cópia
        function copyToClipboard() {
            const text = document.getElementById('final-text').innerText;
            const textArea = document.createElement("textarea");
            textArea.value = text;
            document.body.appendChild(textArea);
            textArea.select();
            document.execCommand('copy');
            document.body.removeChild(textArea);
            
            const btn = document.getElementById('copy-btn');
            const original = btn.innerHTML;
            btn.innerHTML = `<i data-lucide="check" class="w-3 h-3"></i> COPIADO!`;
            btn.classList.add('bg-green-600');
            lucide.createIcons();
            
            setTimeout(() => {
                btn.innerHTML = original;
                btn.classList.remove('bg-green-600');
                lucide.createIcons();
            }, 2000);
        }
    </script>
</body>
</html>
